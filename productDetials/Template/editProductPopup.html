<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Product Details Popup</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<style>
    .productSubmit{
                border-radius: 20px;
                background-color: #f5ab1e;
                color: white;
                }
                
    .productSubmit:hover { 
        transition: background-color 0.3s ease;
        background-color: transparent;
        border-color: #f5ab1e;
        color: #f5ab1e;
        }
</style>
<body>
    <div class="container mt-4 d=flex flex-column align-items-center">
        <form action="" class="w-50">
            <h2 class="fw-bold mb-4 text-start">Edit Product</h2>
            <div class="mb-3">
                <label for="updateName" class="form-label fw-bold">Name:</label>
                <input type="text" class="form-control" id="updateName" name="updateName" placeholder="Tomato">
            </div>
            <div class="mb-3">
                <label for="updatePrice" class="form-label fw-bold">Price:</label>
                <input type="text" class="form-control" id="updatePrice" name="updatePrice" placeholder="5.50">
            </div>
            <div class="mb-3">
                <label for="updateDescription" class="form-label fw-bold">Description:</label>
                <input type="text" class="form-control" id="updateDescription" name="updateDescription" placeholder="Lorem">
            </div>
            <div class="mb-3">
                <label for="updateStock" class="form-label fw-bold">Stock(1 stock for every KG):</label>
                <input type="text" class="form-control" id="updateStock" name="updateStock" placeholder="200">
            </div>
            <div class="mb-3">
                <label for="category" class="form-label fw-bold">Category:</label>
                <select class="form-select" id="category" aria-label="Categories">
                    <option value="bagel">Bagel</option>
                    <option value="candy">Candy</option>
                    <option value="beans">Beans</option>
                    <option value="bestseller">Bestseller</option>
                    <option value="bread">Bread</option>
                    <option value="biscuite">Biscuite</option>
                    <option value="breakfast">Breakfast</option>
                    <option value="cake">Cake</option>
                    <option value="cookie">Cookie</option>
                    <option value="cupcake">Cupcake</option>
                    <option value="Dairy&Cheese">Dairy & Cheese</option>
                    <option value="Dinner">Dinner</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="updateImage" class="form-label fw-bold">Image:</label>
                <input type="text" class="form-control" id="updateImage" name="updateImage" placeholder="images.google.com">
            </div>
             <div class="mb-3">
                <label for="sizes" class="form-label fw-bold">Size (KG):</label>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" id="sizesDropdown" data-bs-toggle="dropdown">Select Sizes</button>
                    <ul class="dropdown-menu w-100 p-3" style="max-height: 200px" >
                        <li>
                            <div class="form-check">
                                <input class="form-check-input size-option" type="checkbox" value="1" id="size1">
                                <label for="size1">1 KG</label>
                            </div>
                        </li>
                        <li>
                            <div class="form-check">
                                <input class="form-check-input size-option" type="checkbox" value="2" id="size2">
                                <label for="size2">2 KG</label>
                            </div>
                        </li>
                        <li>
                            <div class="form-check">
                                <input class="form-check-input size-option" type="checkbox" value="3" id="size3">
                                <label for="size3">3 KG</label>
                            </div>
                        </li>
                        <li>
                            <div class="form-check">
                                <input class="form-check-input size-option" type="checkbox" value="4" id="size4">
                                <label  for="size4">4 KG</label>
                            </div>
                        </li>
                        <li>
                            <div class="form-check">
                                <input class="form-check-input size-option" type="checkbox" value="5" id="size5">
                                <label for="size5">5 KG</label>
                            </div>
                        </li>
                    </ul>
                </div>
                <div id="sizesError"></div>

            </div>
            <div class="mb-3">
                <label for="discount" class="form-label fw-bold">Discount (%):</label>
                <input type="text" class="form-control" id="discountPercentage" name="discountPercentage" placeholder="20%">
            </div>
            <div class="d-grid">
                <button type="submit" class="productSubmit btn btn-light fw-bold mt-2 px-4 py-2">Submit</button>
            </div>
        </form>
    </div>
    <!-- <script src="https://code.jquery.com/jquery-4.0.0.min.js" integrity="sha256-OaVG6prZf4v69dPg6PhVattBXkcOWQB62pdZ3ORyrao=" crossorigin="anonymous"></script> -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"> </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type = "module">
            import{Product, loadProducts, saveProducts} from "../../component/Product.js"

            $(document).ready(function(){
                if(!currentUser || currentUser.role !== "seller"){
                    throw new Error("Only Sellers can create products");
                    window.location.href = "/productDetails.html";
                }
                const sellerId = currentUser.id;
                const params = new URLSearchParams(window.location.search);
                const productId = parseInt(params.get("id"));

                let products = loadProducts() || [];

                let product = products.find(p => p.ID == productId);
                //let product = products.find(p => Number(p.ID) === Number(productId));
                if(!product){
                    alert("Product not found");
                    window.location.href = "../../productList/Template/product_list.html"
                }
                
                $("#updateName").val(product.Name);
                $("#updatePrice").val(product.Price);
                $("#updateDescription").val(product.Description);
                $("#updateStock").val(product.Stock);
                $("#category").val(product.Category);
                $("#updateImage").val(product.ImageUrl);
                //$("#updateSize").val(product.Sizes);
                product.Sizes.forEach(size =>{
                        $(`.size-option[value="${size}"]`).prop("checked", true);
                });
                $("#discountPercentage").val(product.DiscountPercentage);
                
                const allowedCategories = [
                    "bagel", "candy", "beans", "bestseller", "bread", "biscuite", "breakfast", "cake", "cookie", "cupcake", "Dairy&Cheese", "Dinner"
                ];
                $("form").on("submit", function(e){
                    e.preventDefault();
                    let isValid = true;

                    $(".form-control").removeClass("is-invalid");
                    $(".invalid-feedback").remove();

                    let name = $("#updateName").val().trim();
                    let price = parseFloat($("#updatePrice").val());
                    let description = $("#updateDescription").val().trim();
                    let stock = parseInt($("#updateStock").val());
                    let category = $("#category").val().trim();
                    let image = $("#updateImage").val().trim();
                    // let size = parseInt($("#size")).val();

                    let sizes = $(".size-option:checked").map(function(){
                        return parseInt($(this).val(),10);
                    }).get();

                    let discountPercentage = parseInt($("#discountPercentage").val());

                    if (name.length<3){
                        showError("#updateName", "Name must be at least 3 characters");
                        isValid = false;
                    }
                    if (isNaN(price) || price<=0){
                        showError("#updatePrice", "Price must be a number greater than 0");
                        isValid = false;
                    }
                    if (description.length < 100 || description.length > 200){
                        showError("#updateDescription", "Description must be at least 100 characters and less than 200");
                        isValid = false;
                    }
                    if (isNaN(stock) || stock<=0){
                        showError("#updateStock", "Stock must be a number greater than 0");
                        isValid = false;
                    }
                    if (!allowedCategories.includes(category)){
                        showError("#category", "Invalid Category, allowed categories: bagel, candy, beans, bestseller, bread, biscuite, breakfast, cake, cookie, cupcake, Dairy&Cheese, Dinner");
                        isValid = false;
                    }
                    if (!isValidURL(image)) {
                        showError("#updateImage", "Enter a valid image URL.");
                        isValid = false;
                    }
                    if (sizes.length === 0) {
                        $("#sizesError").html('<div class="text-danger mt-2">Please select at least one size</div>');
                        isValid = false;
                    } else {
                        $("#sizesError").html("");
                    }
                    if(isNaN(discountPercentage) || discountPercentage<0 || discountPercentage>100){
                        showError("#discountPercentage","Discount Percentage must be a number between 0 and 100");
                        isValid = false;
                    }
                    if (!isValid) return;

                    try{
                        product.Name = name;
                        product.Price = price;
                        product.Description = description;
                        product.Stock = parseInt($("#updateStock").val());
                        product.Category = category;
                        product.ImageUrl = image;
                        product.Sizes = sizes;
                        product.DiscountPercentage = discountPercentage;

                        saveProducts(products);

                        alert("Product updated successfully");
                        window.location.href = `SellerProductDetaill.html?id=${product.ID}`;
                    
                    }catch(error){
                        alert(error.message)
                    }
                });
                
                $(".dropdown-menu").on("click", function(e){
                    e.stopPropagation();
                });
                $(".size-option").on("change", function(){
                    let selected = $(".size-option:checked").map(function(){
                        return $(this).next("label").text();
                    }).get();

                    if(selected.length === 0){
                        $("#sizesDropdown").text("Select Sizes");
                    } else{
                        $("#sizesDropdown").text(selected.join(", "));
                    }
                });

                function showError(selector, message){
                    $(selector).addClass("is-invalid");
                    $(selector).after(`<div class= "invalid-feedback">${message}<div>`);
                }
                function isValidURL(url){
                    try{
                        new URL(url);
                        return true;
                    } catch(err){
                        return false;
                    }
                }
                console.log("URL ID:", productId);
                console.log("All IDs:", products.map(p => p.ID));
            });
        </script>

</body>